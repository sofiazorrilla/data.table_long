<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.450">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>.SD()</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="styles.css">
</head>

<body class="nav-sidebar floating nav-fixed">


<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
        <div class="quarto-navbar-tools ms-auto">
    <div class="dropdown">
      <a href="" title="" id="quarto-navigation-tool-dropdown-0" class="quarto-navigation-tool dropdown-toggle px-1" data-bs-toggle="dropdown" aria-expanded="false" aria-label=""><i class="bi bi-github"></i></a>
      <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="quarto-navigation-tool-dropdown-0">
          <li>
            <a class="dropdown-item quarto-navbar-tools ms-auto-item" href="https://github.com/sofiazorrilla/data.table_long/blob/main/README.md">
            Source Code
            </a>
          </li>
      </ul>
    </div>
</div>
          <div id="quarto-search" class="" title="Search"></div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
      <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./tema3.html">Operaciones</a></li><li class="breadcrumb-item"><a href="./tema9.html">.SD()</a></li></ol></nav>
      <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
      </a>
      <button type="button" class="btn quarto-search-button" aria-label="" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal sidebar-navigation floating overflow-auto">
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
 <span class="menu-text">Introducción</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Introducción y recursos</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./tema1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Sintaxis básica</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./tema2.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Importar y exportar datos</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">
 <span class="menu-text">Operaciones</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./tema3.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Filtros y selección de columnas</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./tema4.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Modificación de columnas</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./tema5.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Agrupación y cadenas de operaciones</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./tema6.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Ejercicios</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./tema7.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Uniones entre tablas</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./tema8.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Reformatear tablas</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./tema9.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">.SD()</span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#sd-para-hacer-subconjuntos" id="toc-sd-para-hacer-subconjuntos" class="nav-link active" data-scroll-target="#sd-para-hacer-subconjuntos">SD para hacer subconjuntos</a></li>
  <li><a href="#aplicar-funciones-sobre-los-subconjuntos-de-columnas" id="toc-aplicar-funciones-sobre-los-subconjuntos-de-columnas" class="nav-link" data-scroll-target="#aplicar-funciones-sobre-los-subconjuntos-de-columnas">Aplicar funciones sobre los subconjuntos de columnas</a></li>
  <li><a href="#aplicar-modelos-con-distintas-variables-explicativas-right-hand-side-rhs" id="toc-aplicar-modelos-con-distintas-variables-explicativas-right-hand-side-rhs" class="nav-link" data-scroll-target="#aplicar-modelos-con-distintas-variables-explicativas-right-hand-side-rhs">Aplicar modelos con distintas variables explicativas (right hand side = rhs)</a></li>
  <li><a href="#uniones-condicionales" id="toc-uniones-condicionales" class="nav-link" data-scroll-target="#uniones-condicionales">Uniones condicionales</a></li>
  <li><a href="#operaciones-sobre-grupos" id="toc-operaciones-sobre-grupos" class="nav-link" data-scroll-target="#operaciones-sobre-grupos">Operaciones sobre grupos</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">.SD()</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<p>Una herramienta muy útil en data.table es <code>.SD</code>. El nombre viene de <code>.S</code>ubset <code>D</code>ata.table y se puede pensar que es una autoreferencia a la misma tabla. Es difícil describir los usos de .SD por lo que lo haremos a través de ejemplos.</p>
<section id="sd-para-hacer-subconjuntos" class="level2">
<h2 class="anchored" data-anchor-id="sd-para-hacer-subconjuntos">SD para hacer subconjuntos</h2>
<p>El uso más sencillo de .SD es la realización de subconjuntos. Un uso trivial sería generar el subconjunto de toda la tabla.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">identical</span>(data, data[ , .SD])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] TRUE</code></pre>
</div>
</div>
<p>También se puede usar para hacer subconjuntos de columnas. En <code>.SDcols</code> se pueden especificar las columnas a las que hace referencia <code>.SD</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>data[,.SD,.SDcols <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"artists"</span>,<span class="st">"name"</span>)] <span class="sc">%&gt;%</span> <span class="fu">str</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Classes 'data.table' and 'data.frame':  1179453 obs. of  2 variables:
 $ artists: chr  "Lady Gaga, Bruno Mars" "Billie Eilish" "Sabrina Carpenter" "Sabrina Carpenter" ...
 $ name   : chr  "Die With A Smile" "BIRDS OF A FEATHER" "Taste" "Espresso" ...
 - attr(*, ".internal.selfref")=&lt;externalptr&gt; </code></pre>
</div>
</div>
<p>Otro ejemplo más útil: en secciones anteriores del taller les pedí que generaran un subconjunto de data que solo tuviera las variables numéricas de la tabla. Utilizando .SD lo podemos hacer fácilmente si especificamos la condición de que las columnas sean numéricas en el argumento <code>.SDcols</code></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>data[,.SD, .SDcols <span class="ot">=</span> is.numeric] <span class="sc">%&gt;%</span> <span class="fu">str</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Classes 'data.table' and 'data.frame':  1179453 obs. of  17 variables:
 $ daily_rank      : int  1 2 3 4 5 6 7 8 9 10 ...
 $ daily_movement  : int  0 0 0 46 0 2 43 1 -2 1 ...
 $ weekly_movement : int  0 0 0 46 0 1 43 0 41 -1 ...
 $ popularity      : int  97 100 94 83 94 96 84 97 77 91 ...
 $ duration_ms     : int  251667 210373 157279 175459 170887 195824 186365 218423 190427 180304 ...
 $ danceability    : num  0.521 0.747 0.674 0.699 0.66 0.924 0.675 0.7 0.466 0.472 ...
 $ energy          : num  0.592 0.507 0.907 0.776 0.756 0.668 0.586 0.582 0.872 0.471 ...
 $ key             : int  6 2 3 0 0 11 9 11 7 10 ...
 $ loudness        : num  -7.78 -10.17 -4.09 -5.28 -3.74 ...
 $ mode            : int  0 1 1 1 0 1 1 0 1 1 ...
 $ speechiness     : num  0.0304 0.0358 0.064 0.0293 0.032 0.0469 0.0531 0.0356 0.0336 0.0603 ...
 $ acousticness    : num  0.308 0.2 0.101 0.131 0.00289 0.446 0.257 0.0502 0.0156 0.151 ...
 $ instrumentalness: num  0.00 6.08e-02 0.00 5.36e-06 0.00 5.94e-04 0.00 0.00 0.00 0.00 ...
 $ liveness        : num  0.122 0.117 0.297 0.205 0.193 0.0678 0.104 0.0881 0.121 0.14 ...
 $ valence         : num  0.535 0.438 0.721 0.708 0.838 0.787 0.621 0.785 0.806 0.219 ...
 $ tempo           : num  158 105 113 104 116 ...
 $ time_signature  : int  3 4 4 4 4 4 4 4 4 3 ...
 - attr(*, ".internal.selfref")=&lt;externalptr&gt; </code></pre>
</div>
</div>
</section>
<section id="aplicar-funciones-sobre-los-subconjuntos-de-columnas" class="level2">
<h2 class="anchored" data-anchor-id="aplicar-funciones-sobre-los-subconjuntos-de-columnas">Aplicar funciones sobre los subconjuntos de columnas</h2>
<p>También podemos utilizar .SD para refereciar un subconjunto de columnas y aplicar funciones sobre ellas. Por ejemplo, imagina si quisieras cambiar el tipo de datos de muchas columnas fácilmente. Para este ejemplo vamos a volver a leer la tabla de las canciones populares, sin embargo, esta vez vamos a asignar a todas las columnas el tipo de datos de caracter.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>data <span class="ot">=</span> <span class="fu">fread</span>(<span class="st">"data/universal_top_spotify_songs.csv.gz"</span>, <span class="at">colClasses =</span> <span class="st">'character'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Primero vamos a utilizar la función <code>patterns()</code> en <code>.SDcols()</code> para seleccionar las columnas que se refieren a fechas. Modificamos el tipo de datos de las columnas seleccionadas con ese patrón a fecha.</p>
<p><img src="img/sd1.png" class="img-fluid"></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Cambiar el tipo de datos a las columnas de fechas </span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>data[,<span class="fu">names</span>(.SD) <span class="sc">:</span><span class="er">=</span> <span class="fu">lapply</span>(.SD,as.Date),.SDcols <span class="ot">=</span> <span class="fu">patterns</span>(<span class="st">'_date'</span>)]</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Classes 'data.table' and 'data.frame':  1179453 obs. of  25 variables:
 $ spotify_id        : chr  "2plbrEY59IikOBgBGLjaoe" "6dOtVTDdiauQNBQEDOtlAB" "5G2f63n7IPVPPjfNIGih7Q" "2HRqTpkrJO5ggZyyK6NPWz" ...
 $ name              : chr  "Die With A Smile" "BIRDS OF A FEATHER" "Taste" "Espresso" ...
 $ artists           : chr  "Lady Gaga, Bruno Mars" "Billie Eilish" "Sabrina Carpenter" "Sabrina Carpenter" ...
 $ daily_rank        : chr  "1" "2" "3" "4" ...
 $ daily_movement    : chr  "0" "0" "0" "46" ...
 $ weekly_movement   : chr  "0" "0" "0" "46" ...
 $ country           : chr  "" "" "" "" ...
 $ snapshot_date     : Date, format: "2024-09-08" "2024-09-08" "2024-09-08" "2024-09-08" ...
 $ popularity        : chr  "97" "100" "94" "83" ...
 $ is_explicit       : chr  "False" "False" "False" "True" ...
 $ duration_ms       : chr  "251667" "210373" "157279" "175459" ...
 $ album_name        : chr  "Die With A Smile" "HIT ME HARD AND SOFT" "Short n' Sweet" "Short n' Sweet" ...
 $ album_release_date: Date, format: "2024-08-16" "2024-05-17" "2024-08-23" "2024-08-23" ...
 $ danceability      : chr  "0.521" "0.747" "0.674" "0.699" ...
 $ energy            : chr  "0.592" "0.507" "0.907" "0.776" ...
 $ key               : chr  "6" "2" "3" "0" ...
 $ loudness          : chr  "-7.777" "-10.171" "-4.086" "-5.282" ...
 $ mode              : chr  "0" "1" "1" "1" ...
 $ speechiness       : chr  "0.0304" "0.0358" "0.064" "0.0293" ...
 $ acousticness      : chr  "0.308" "0.2" "0.101" "0.131" ...
 $ instrumentalness  : chr  "0.0" "0.0608" "0.0" "5.36e-06" ...
 $ liveness          : chr  "0.122" "0.117" "0.297" "0.205" ...
 $ valence           : chr  "0.535" "0.438" "0.721" "0.708" ...
 $ tempo             : chr  "157.969" "104.978" "112.964" "103.963" ...
 $ time_signature    : chr  "3" "4" "4" "4" ...
 - attr(*, ".internal.selfref")=&lt;externalptr&gt; </code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Cambiar el tipo de datos a las columnas numéricas</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>numeric_cols <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"daily_rank"</span>,<span class="st">"daily_movement"</span>,<span class="st">"weekly_movement"</span>,<span class="st">"popularity"</span>,<span class="st">"duration_ms"</span>,<span class="st">"danceability"</span>,<span class="st">"energy"</span>,<span class="st">"key"</span>,<span class="st">"loudness"</span>,<span class="st">"mode"</span>,<span class="st">"speechiness"</span>,<span class="st">"acousticness"</span>,<span class="st">"instrumentalness"</span>,<span class="st">"liveness"</span>,<span class="st">"valence"</span>,<span class="st">"tempo"</span>,<span class="st">"time_signature"</span>)</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>data[,<span class="fu">names</span>(.SD) <span class="sc">:</span><span class="er">=</span> <span class="fu">lapply</span>(.SD,as.numeric), .SDcols <span class="ot">=</span> numeric_cols]</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Classes 'data.table' and 'data.frame':  1179453 obs. of  25 variables:
 $ spotify_id        : chr  "2plbrEY59IikOBgBGLjaoe" "6dOtVTDdiauQNBQEDOtlAB" "5G2f63n7IPVPPjfNIGih7Q" "2HRqTpkrJO5ggZyyK6NPWz" ...
 $ name              : chr  "Die With A Smile" "BIRDS OF A FEATHER" "Taste" "Espresso" ...
 $ artists           : chr  "Lady Gaga, Bruno Mars" "Billie Eilish" "Sabrina Carpenter" "Sabrina Carpenter" ...
 $ daily_rank        : num  1 2 3 4 5 6 7 8 9 10 ...
 $ daily_movement    : num  0 0 0 46 0 2 43 1 -2 1 ...
 $ weekly_movement   : num  0 0 0 46 0 1 43 0 41 -1 ...
 $ country           : chr  "" "" "" "" ...
 $ snapshot_date     : Date, format: "2024-09-08" "2024-09-08" "2024-09-08" "2024-09-08" ...
 $ popularity        : num  97 100 94 83 94 96 84 97 77 91 ...
 $ is_explicit       : chr  "False" "False" "False" "True" ...
 $ duration_ms       : num  251667 210373 157279 175459 170887 ...
 $ album_name        : chr  "Die With A Smile" "HIT ME HARD AND SOFT" "Short n' Sweet" "Short n' Sweet" ...
 $ album_release_date: Date, format: "2024-08-16" "2024-05-17" "2024-08-23" "2024-08-23" ...
 $ danceability      : num  0.521 0.747 0.674 0.699 0.66 0.924 0.675 0.7 0.466 0.472 ...
 $ energy            : num  0.592 0.507 0.907 0.776 0.756 0.668 0.586 0.582 0.872 0.471 ...
 $ key               : num  6 2 3 0 0 11 9 11 7 10 ...
 $ loudness          : num  -7.78 -10.17 -4.09 -5.28 -3.74 ...
 $ mode              : num  0 1 1 1 0 1 1 0 1 1 ...
 $ speechiness       : num  0.0304 0.0358 0.064 0.0293 0.032 0.0469 0.0531 0.0356 0.0336 0.0603 ...
 $ acousticness      : num  0.308 0.2 0.101 0.131 0.00289 0.446 0.257 0.0502 0.0156 0.151 ...
 $ instrumentalness  : num  0.00 6.08e-02 0.00 5.36e-06 0.00 5.94e-04 0.00 0.00 0.00 0.00 ...
 $ liveness          : num  0.122 0.117 0.297 0.205 0.193 0.0678 0.104 0.0881 0.121 0.14 ...
 $ valence           : num  0.535 0.438 0.721 0.708 0.838 0.787 0.621 0.785 0.806 0.219 ...
 $ tempo             : num  158 105 113 104 116 ...
 $ time_signature    : num  3 4 4 4 4 4 4 4 4 3 ...
 - attr(*, ".internal.selfref")=&lt;externalptr&gt; </code></pre>
</div>
</div>
</section>
<section id="aplicar-modelos-con-distintas-variables-explicativas-right-hand-side-rhs" class="level2">
<h2 class="anchored" data-anchor-id="aplicar-modelos-con-distintas-variables-explicativas-right-hand-side-rhs">Aplicar modelos con distintas variables explicativas (right hand side = rhs)</h2>
<p><img src="img/sd2.png" class="img-fluid"></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>num_vars <span class="ot">&lt;-</span> data[,.SD, .SDcols <span class="ot">=</span> is.numeric] </span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(num_vars)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] "daily_rank"       "daily_movement"   "weekly_movement"  "popularity"       "duration_ms"      "danceability"    
 [7] "energy"           "key"              "loudness"         "mode"             "speechiness"      "acousticness"    
[13] "instrumentalness" "liveness"         "valence"          "tempo"            "time_signature"  </code></pre>
</div>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>vars <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"danceability"</span>,<span class="st">"energy"</span>,<span class="st">"loudness"</span>,<span class="st">"valence"</span>)</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Queremos generar modelos para evaluar como es que diferentes variables afectan la popularidad de las canciones.</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>models <span class="ot">=</span> <span class="fu">unlist</span>(</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lapply</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(vars), combn, <span class="at">x =</span> vars, <span class="at">simplify =</span> <span class="cn">FALSE</span>),</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">recursive =</span> <span class="cn">FALSE</span></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>lms <span class="ot">=</span> <span class="fu">lapply</span>(models, <span class="cf">function</span>(rhs) {</span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a> data[snapshot_date <span class="sc">==</span> <span class="fu">max</span>(snapshot_date),][, </span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>      .( <span class="at">call =</span> <span class="fu">paste</span>(<span class="st">"popularity ~ "</span>,<span class="fu">paste</span>(rhs,<span class="at">collapse =</span> <span class="st">" + "</span>)),</span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>         <span class="at">terms =</span> <span class="fu">c</span>(<span class="st">"Intercept"</span>,rhs),</span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>         <span class="at">coefs =</span> <span class="fu">coef</span>(<span class="fu">lm</span>(popularity <span class="sc">~</span> ., <span class="at">data =</span> .SD)),</span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a>         <span class="at">pvals =</span> <span class="fu">summary</span>(<span class="fu">lm</span>(popularity <span class="sc">~</span> ., <span class="at">data =</span> .SD))<span class="sc">$</span>coefficients[,<span class="dv">4</span>],</span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a>         <span class="at">radj =</span> <span class="fu">summary</span>(<span class="fu">lm</span>(popularity <span class="sc">~</span> ., <span class="at">data =</span> .SD))<span class="sc">$</span>adj.r.squared), .SDcols <span class="ot">=</span> rhs]</span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a>results <span class="ot">&lt;-</span> <span class="fu">do.call</span>(rbind,lms)</span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a>results</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                                                        call        terms       coefs         pvals          radj
                                                      &lt;char&gt;       &lt;char&gt;       &lt;num&gt;         &lt;num&gt;         &lt;num&gt;
 1:                               popularity ~  danceability    Intercept  80.7967185  0.000000e+00  0.0038409790
 2:                               popularity ~  danceability danceability  -7.0185585  1.054422e-04  0.0038409790
 3:                                     popularity ~  energy    Intercept  75.3984610  0.000000e+00 -0.0001964094
 4:                                     popularity ~  energy       energy   0.8393845  5.944860e-01 -0.0001964094
 5:                                   popularity ~  loudness    Intercept  81.1326815  0.000000e+00  0.0185124047
 6:                                   popularity ~  loudness     loudness   0.8404004  9.094862e-17  0.0185124047
 7:                                    popularity ~  valence    Intercept  76.4707397  0.000000e+00 -0.0001009337
 8:                                    popularity ~  valence      valence  -0.8735183  4.267732e-01 -0.0001009337
 9:                      popularity ~  danceability + energy    Intercept  79.8274497  0.000000e+00  0.0038830556
10:                      popularity ~  danceability + energy danceability  -7.2866017  6.667336e-05  0.0038830556
11:                      popularity ~  danceability + energy       energy   1.7063111  2.827648e-01  0.0038830556
12:                    popularity ~  danceability + loudness    Intercept  87.2954408  0.000000e+00  0.0242839740
13:                    popularity ~  danceability + loudness danceability  -8.5421084  2.094869e-06  0.0242839740
14:                    popularity ~  danceability + loudness     loudness   0.8865057  2.081684e-18  0.0242839740
15:                     popularity ~  danceability + valence    Intercept  80.6688428  0.000000e+00  0.0037116726
16:                     popularity ~  danceability + valence danceability  -7.5545692  1.117191e-04  0.0037116726
17:                     popularity ~  danceability + valence      valence   0.8598207  4.681146e-01  0.0037116726
18:                          popularity ~  energy + loudness    Intercept  95.5444590  0.000000e+00  0.0318278066
19:                          popularity ~  energy + loudness       energy -15.2170897  1.018161e-12  0.0318278066
20:                          popularity ~  energy + loudness     loudness   1.5109508  7.496977e-28  0.0318278066
21:                           popularity ~  energy + valence    Intercept  75.6821337  0.000000e+00 -0.0001632938
22:                           popularity ~  energy + valence       energy   1.4861428  3.794880e-01 -0.0001632938
23:                           popularity ~  energy + valence      valence  -1.2478374  2.898194e-01 -0.0001632938
24:                         popularity ~  loudness + valence    Intercept  83.6290602  0.000000e+00  0.0207621082
25:                         popularity ~  loudness + valence     loudness   0.9224723  1.098387e-18  0.0207621082
26:                         popularity ~  loudness + valence      valence  -3.4472810  2.208550e-03  0.0207621082
27:           popularity ~  danceability + energy + loudness    Intercept 100.0481692 1.430542e-314  0.0360083632
28:           popularity ~  danceability + energy + loudness danceability  -7.3625488  4.208326e-05  0.0360083632
29:           popularity ~  danceability + energy + loudness       energy -14.3638888  1.901093e-11  0.0360083632
30:           popularity ~  danceability + energy + loudness     loudness   1.5130927  4.900052e-28  0.0360083632
31:            popularity ~  danceability + energy + valence    Intercept  79.8800544  0.000000e+00  0.0036504766
32:            popularity ~  danceability + energy + valence danceability  -7.5546944  1.117446e-04  0.0036504766
33:            popularity ~  danceability + energy + valence       energy   1.4866175  3.784253e-01  0.0036504766
34:            popularity ~  danceability + energy + valence      valence   0.4854107  6.998260e-01  0.0036504766
35:          popularity ~  danceability + loudness + valence    Intercept  87.8106988  0.000000e+00  0.0245573824
36:          popularity ~  danceability + loudness + valence danceability  -7.5322741  9.897288e-05  0.0245573824
37:          popularity ~  danceability + loudness + valence     loudness   0.9219472  9.869172e-19  0.0245573824
38:          popularity ~  danceability + loudness + valence      valence  -1.7175924  1.550976e-01  0.0245573824
39:                popularity ~  energy + loudness + valence    Intercept  95.9081399  0.000000e+00  0.0319746744
40:                popularity ~  energy + loudness + valence       energy -14.4959094  5.522847e-11  0.0319746744
41:                popularity ~  energy + loudness + valence     loudness   1.5135831  6.128533e-28  0.0319746744
42:                popularity ~  energy + loudness + valence      valence  -1.4453949  2.127262e-01  0.0319746744
43: popularity ~  danceability + energy + loudness + valence    Intercept 100.0722375 4.269257e-314  0.0357573432
44: popularity ~  danceability + energy + loudness + valence danceability  -7.5167704  9.323801e-05  0.0357573432
45: popularity ~  danceability + energy + loudness + valence       energy -14.4853624  5.234013e-11  0.0357573432
46: popularity ~  danceability + energy + loudness + valence     loudness   1.5126290  5.234112e-28  0.0357573432
47: popularity ~  danceability + energy + loudness + valence      valence   0.2792770  8.216176e-01  0.0357573432
                                                        call        terms       coefs         pvals          radj</code></pre>
</div>
</div>
</section>
<section id="uniones-condicionales" class="level2">
<h2 class="anchored" data-anchor-id="uniones-condicionales">Uniones condicionales</h2>
<p>Queremos realizar una unión entre dos tablas: <code>Sales</code> y <code>Targets.</code> La tabla <code>Sales</code> contiene las ventas de diferentes tiendas en fechas específicas (sale_date), mientras que la tabla <code>Targets</code> tiene los objetivos de ventas (target) por tienda dentro de intervalos de fechas (start_date y end_date). El objetivo es asignar el valor de target de <code>Targets</code> a cada venta de <code>Sales</code>, basado en si la fecha de venta cae dentro del intervalo de fechas correspondiente para esa tienda.</p>
<ol type="1">
<li>Sales</li>
</ol>
<table class="table">
<thead>
<tr class="header">
<th>storeID</th>
<th>sale_date</th>
<th>amount</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1</td>
<td>2023-01-15</td>
<td>500</td>
</tr>
<tr class="even">
<td>1</td>
<td>2023-03-10</td>
<td>750</td>
</tr>
<tr class="odd">
<td>2</td>
<td>2023-04-01</td>
<td>1200</td>
</tr>
<tr class="even">
<td>2</td>
<td>2023-02-15</td>
<td>600</td>
</tr>
</tbody>
</table>
<ol start="2" type="1">
<li>Targets Table</li>
</ol>
<table class="table">
<thead>
<tr class="header">
<th>storeID</th>
<th>start_date</th>
<th>end_date</th>
<th>target</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1</td>
<td>2023-01-01</td>
<td>2023-03-31</td>
<td>600</td>
</tr>
<tr class="even">
<td>1</td>
<td>2023-04-01</td>
<td>2023-06-30</td>
<td>800</td>
</tr>
<tr class="odd">
<td>2</td>
<td>2023-01-01</td>
<td>2023-03-31</td>
<td>1000</td>
</tr>
<tr class="even">
<td>2</td>
<td>2023-04-01</td>
<td>2023-06-30</td>
<td>1200</td>
</tr>
</tbody>
</table>
<p>¿Cómo podemos asignar los objetivos de ventas (target) de un intervalo de fechas en la tabla Targets a las fechas de ventas específicas en la tabla Sales, asegurando que cada transacción tenga el objetivo correcto según el intervalo de fechas al que pertenece?</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>Sales <span class="ot">&lt;-</span> <span class="fu">data.table</span>(</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">storeID =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">2</span>),</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">sale_date =</span> <span class="fu">as.IDate</span>(<span class="fu">c</span>(<span class="st">"2023-01-15"</span>, <span class="st">"2023-03-10"</span>, <span class="st">"2023-04-01"</span>, <span class="st">"2023-02-15"</span>)),</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">amount =</span> <span class="fu">c</span>(<span class="dv">500</span>, <span class="dv">750</span>, <span class="dv">1200</span>, <span class="dv">600</span>)</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>Targets <span class="ot">&lt;-</span> <span class="fu">data.table</span>(</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">storeID =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">2</span>),</span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">start_date =</span> <span class="fu">as.IDate</span>(<span class="fu">c</span>(<span class="st">"2023-01-01"</span>, <span class="st">"2023-04-01"</span>, <span class="st">"2023-01-01"</span>, <span class="st">"2023-04-01"</span>)),</span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">end_date =</span> <span class="fu">as.IDate</span>(<span class="fu">c</span>(<span class="st">"2023-03-31"</span>, <span class="st">"2023-06-30"</span>, <span class="st">"2023-03-31"</span>, <span class="st">"2023-06-30"</span>)),</span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">target =</span> <span class="fu">c</span>(<span class="dv">600</span>, <span class="dv">800</span>, <span class="dv">1000</span>, <span class="dv">1200</span>)</span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Add start_date and end_date to Sales as the same value (to use for range-based join)</span></span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a>Sales[, <span class="fu">c</span>(<span class="st">"start_date"</span>,<span class="st">"end_date"</span>)<span class="sc">:</span><span class="er">=</span>.(sale_date,sale_date)]</span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Join Sales and Targets based on storeID and date range, and assign target as team_performance</span></span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a>Sales[storeID <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>), </span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a>      target <span class="sc">:</span><span class="er">=</span> Targets[.SD, target, on <span class="ot">=</span> .(storeID, start_date <span class="sc">&lt;=</span> end_date, end_date <span class="sc">&gt;=</span> start_date)]]</span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true" tabindex="-1"></a>Sales</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Index: &lt;storeID&gt;
   storeID  sale_date amount start_date   end_date target
     &lt;num&gt;     &lt;IDat&gt;  &lt;num&gt;     &lt;IDat&gt;     &lt;IDat&gt;  &lt;num&gt;
1:       1 2023-01-15    500 2023-01-15 2023-01-15    600
2:       1 2023-03-10    750 2023-03-10 2023-03-10    600
3:       2 2023-04-01   1200 2023-04-01 2023-04-01   1200
4:       2 2023-02-15    600 2023-02-15 2023-02-15   1000</code></pre>
</div>
</div>
</section>
<section id="operaciones-sobre-grupos" class="level2">
<h2 class="anchored" data-anchor-id="operaciones-sobre-grupos">Operaciones sobre grupos</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>song_freq <span class="ot">&lt;-</span> data[,.N, by <span class="ot">=</span> .(country,name)]</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Que cancion tiene el mayor numero de registros por pais </span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>song_freq[,.SD[<span class="fu">which.max</span>(N)], by <span class="ot">=</span> country] <span class="sc">%&gt;%</span> <span class="fu">head</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   country                                          name     N
    &lt;char&gt;                                        &lt;char&gt; &lt;int&gt;
1:                                          Cruel Summer   318
2:      ZA                                         Paris   313
3:      VN           Seven (feat. Latto) (Explicit Ver.)   325
4:      VE                                      AMARGURA   320
5:      UY                                       Tu y Yo   321
6:      US I Remember Everything (feat. Kacey Musgraves)   318</code></pre>
</div>
</div>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>